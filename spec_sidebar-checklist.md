【2026-01-15 13:xx JST】

# サイドバー常駐チェックリスト（最小構成）仕様書（確定版 v1.1）

最終更新：2026-01-15（JST）

---

## 1. 目的
- Windows 11 上で常時参照できるチェックリストをサイドバーとして提供し、業務のケアレスミス低減を支援する。
- 通常のWindowsアプリを最大化してもサイドバー領域に重ならない挙動（作業領域確保）を実現する。
- 機能を最小構成に絞り、挙動と運用適合性を先に確認する。

---

## 2. 対象環境・前提
- OS：Windows 11（64bit）
- 対象アプリ：通常のWindowsアプリ（ゲーム等の例外は対象外）
- タスクバー位置：下固定のみ想定（上/左/右は対象外）
- マルチモニタ：最大2枚（メイン＋サブ）。2枚以上は考慮しない
- UIデザイン：Windowsのデフォルト（WPF既定スタイル）に準ずる  
  - OSのライト／ダーク等のシステム設定への追随（テーマ切替）は初期スコープ外
- 配置運用：アプリは書き込み可能なフォルダに配置して運用する（Program Files 配下には置かない）

---

## 3. 実装方針（技術前提）
- UI：WPF を採用
- サイドバーの「最大化しても被らない」は OS の作業領域確保（AppBar相当）により実現する方針
- 依存を増やさない方針（WinForms依存は避ける）

※ 本書は仕様（要件）であり、実装手段の詳細は技術仕様に分離する。

---

## 4. 起動・終了・多重起動
### 4.1 起動
- 手動起動（ユーザーが任意のタイミングで起動）
- 自動起動（ログオン起動）は不要

### 4.2 終了（「終了」の定義）
- × ボタン、および Alt+F4 はアプリ終了とする
- 非表示概念は持たない（トレイ常駐なし）

### 4.3 多重起動
- 二重起動は許可しない（既存インスタンス優先）

---

## 5. タスクバー表示
- 本アプリはタスクバーに表示する（ユーザーが見失わないため）
- トレイ常駐は行わない

---

## 6. サイドバー表示仕様
### 6.1 ドック位置
- 右端ドック：右固定
- サイドバーは常に表示を優先し、隠す必要はない（自動隠し不要）
- 位置の移動は無効にする（ドラッグ等で移動できない）

### 6.2 最前面
- サイドバーは常に最前面に表示される
- 例外としてリモートデスクトップ接続時は最前面を解除する

### 6.3 “被らない”（作業領域確保）
- 通常アプリを最大化した際、サイドバー領域に重ならないこと
- Win+↑ 等の最大化操作でも同様

---

## 7. マルチモニタ対応（最小範囲）
### 7.1 対応範囲
- メイン／サブ（2枚目）に配置可能
- サブモニタ定義：OSでメイン以外の1台目（＝2台目）
- “右端”は選択中モニタの右端を指す（モニタ切替後も右端ドックを維持）

### 7.2 モニタ切替UI
- ヘッダ右側にテキストボタンとして「メイン」「サブ」を表示
- クリックで表示先を切り替える
- 切替は押下直後に反映（即移動）
- サブモニタが存在しない場合：「サブ」ボタンは無効化（ツールチップ不要）
- 現在選択中が判別できる見た目にする（Windowsデフォルト範囲で表現）
- アクティブモニタボタンは押せないようにする

### 7.3 状態保持
- 表示先モニタは設定として保持し、次回起動に引き継ぐ（12章）

---

## 8. サイズ変更仕様
### 8.1 初期値・制約
- デフォルト幅：400px
- 最小幅：280px
- 最大幅：900px

### 8.2 変更方法
- settings.jsonでのみ変更可能とし、UI上の幅変更ハンドル等は設けない


---

## 9. チェックリスト表示・操作仕様
### 9.1 表示
- 項目は上から固定順で表示
- 長文は折り返し
- 折り返し後の行はチェックマーク分インデントし、本文が揃うこと
- スクロール可能

### 9.2 操作
- 各項目はチェック可能（チェックボックス）
- チェックボックスだけでなく、テキスト部分をクリックしてもチェック／解除できること
- 表示順は固定（並べ替えなし）

### 9.3 チェック状態の保存
- チェック状態は「保存」ボタンをクリックしたタイミングでyyyy-mm-dd.jsonとして保存する
- 保存場所はsettings.jsonで規定されていない限り、アプリと同じディレクトリ
- ファイル名例：2026-01-15.json
- すでに同名ファイルが存在する場合は追記保存（上書きしない）
- 保存形式は以下の通り
- ```json
[
  {
    "id": "mail_send",
    "timestamp": "yyyy-mm-ddThh:mm:ss+09:00",
    "items": [
      {
        "text": "item_name_",
        "is_checked": true/false
      }
    ],
    "checklist_version": "1.0"
  }
]
```

---

## 10. 複数チェックリストの切替
### 10.1 切替UI
- ヘッダ左側にプルダウン（ドロップダウン）を配置し、利用者がチェックリストを選択できること

### 10.2 選択状態
- 選択中のチェックリストは設定として保持し、次回起動に引き継ぐ（12章）
- `selected_list_id` が不正な場合：UI上はエラー表示せず、静かに先頭（lists[0]）へフォールバックする

### 10.3 保存タイミング
- リスト選択：プルダウン変更時に即 settings.json に保存

---

## 11. チェックリスト配布形式（JSON）
- checklist.jsonでアプリディレクトリで配布
- API経由で取得
- 共有サーバから取得


### 11.1.1 ファイル
- ファイル名：checklist.json 固定
- 配置場所：アプリと同じディレクトリ

### 11.1.2 API／共有サーバ
- JSONフォーマットでのAPI取得を可能とする
- 共有サーバからの取得も可能とする
- 取得先URL／パスは settings.json で規定する（オプション項目）
- API／共有サーバから取得する場合、12時間有効なキャッシュ機構を持つ（ローカルの checklist.cache.json をキャッシュとして利用）


### 11.2 形式
- 複数チェックリストを1つのJSONに格納（ファイル分割しない）
- versionを記載する（ただしバージョンチェックは行わない）
- 表示順はJSONの配列順に従う

#### checklist.json（サンプル）
```json
{
  "version": "1.0",
  "lists": [
    {
      "id": "mail_send",
      "name": "メール送信前チェック",
      "items": [
        "宛先（To/Cc/Bcc）を再確認した",
        "添付ファイルが正しい（最新版・機密区分）",
        "本文の数値・日付・固有名詞を再確認した"
      ]
    }
  ]
}
```

### 11.3 エラー時の表示（優先順位）
1) settings.json 無し／読めない → 「JSONファイルエラー」（表示後、終了してよい）  
2) settings OK & checklist.json 無し → 「チェックリストが存在しません」（表示したまま起動継続）  
3) settings OK & checklist.json 破損等 → 「JSONファイルエラー」（表示したまま起動継続）
4) API／共有サーバ取得失敗 → 1. キャッシュが有効ならキャッシュを利用、2. キャッシュ無効なら上記2)扱い

### 11.4 checklist.json の境界条件
- `lists` が空：  
  - 「チェックリストが存在しません」扱い（表示したまま起動継続）
- `lists[].id` が重複：  
  - 「JSONファイルエラー」扱い（表示したまま起動継続）
- `lists[].items` が空：  
  - 空のリストとして表示（UI上のエラー表示は不要）

### 11.5 checklist.json 運用ルール（更新）
- `lists[].id`：既存リストについて変更しない
- `lists[].name`：変更可
- `lists[].items`：追加／削除／変更可
- チェック状態保存は現時点で行わないため、items変更による既存状態への影響は考慮不要（将来検討）

---

## 12. 設定ファイル（JSON）
### 12.1 ファイル
- ファイル名：settings.json 固定
- 配置場所：アプリと同じディレクトリ
- 配布：必ずアプリと一緒に配布（必須ファイル）
- セキュリティを考慮せず、暗号化等は行わない

### 12.2 スキーマ（確定）
```json
{
  "version": "1.0",
  "api": {
    "enabled": false,
    "base_url": "http://127.0.0.1:8000/checklist.json",
    "api_key": "",
    "timeout_ms": 3000
  },
  "window": {
    "sidebar_width_px": 400
  },
  "display": {
    "target_monitor": "main"
  },
  "selection": {
    "selected_list_id": "mail_send"
  },
  "checklist": {
    "font_size": 22,
    "checkbox_size": 16,
    "path": "",
    "save_path": ""
  }
}
```

### 12.3 settings.json エラー時の扱い
- settings.json が存在しない／破損している／読み込み失敗などは一括で「JSONファイルエラー」とし、エラー表示後、終了してよい

### 12.4 値不正時のフォールバック（settingsが読めた場合）
- `window.sidebar_width_px`：280〜900に丸める
- `display.target_monitor`：`main` / `sub` 以外は `main`
- サブモニタが存在しない場合：
  - `target_monitor` が `sub` であっても表示は `main` にフォールバック
- `selection.selected_list_id`：存在しない場合は lists[0] にフォールバック（10.2）

### 12.5 保存タイミング
- モニタ切替：切替後、即 settings.json に保存

---

## 13. 付録A：画面イメージ（文章ベース）
### A-1. 全体レイアウト
- 右端に固定表示される縦長サイドバー。
- 構成は上から順に「ヘッダ／区切り線／チェックリスト本体（スクロール領域）」。

### A-2. ヘッダ（上部固定）
- 1段目：チェックリスト選択プルダウン  
  - checklist.json の `lists[].name` を列挙し、選択中のリスト名を表示
- 2段目：チェックリスト簡易検索
- 3段目：保存、リフレッシュ、モニタ切替ボタン
  - `[メイン] [サブ]` の2つを横並び表示
  - 選択中が分かる見た目（Windowsデフォルト範囲）

### A-3. 区切り線
- ヘッダ直下に薄い区切り線を1本。

### A-4. チェックリスト本体（スクロール領域）
- 各項目は「左：チェックボックス／右：テキスト」。
- 長文は折り返し、2行目以降はチェックボックス分インデント。
- 縦スクロール可能。

### A-5. 例外表示（本体領域に表示）
- settings.json エラー：  
  - 「JSONファイルエラー」表示 → 終了してよい
- checklist.json 無し：  
  - 「チェックリストが存在しません」表示（起動継続）
- checklist.json エラー：  
  - 「JSONファイルエラー」表示（起動継続）

### A-6. サイズ変更UI
- 左端に幅変更用ドラッグ領域がある。
- ドラッグで幅を280〜900pxの範囲で変更できる。

---

## 14. 解像度変更・表示環境変更時の挙動

### 14.1 対象となる表示環境変更
本アプリは、以下の表示環境変更が発生した場合に再配置処理を行う。

- 画面解像度の変更  
  （例：1920×1080 → 2560×1440）
- 表示スケール（DPI）の変更  
  （例：100% → 125%）
- モニタ構成の変更  
  - モニタの接続／切断  
  - メイン／サブモニタの切替
- タスクバー設定の変更  
  （サイズ変更等。ただし位置は下固定前提）

※ 上記は Windows が通知する表示環境変更イベントを契機とする。

---

### 14.2 基本方針
- サイドバーの **位置・サイズのピクセル値を保存・復元しない**
- 表示環境変更が検知された場合、  
  **その時点のモニタ情報から再計算して再配置する**
- 再配置は「最後に指定された設定値（settings.json）」を元に行う

---

### 14.3 サイドバーの再配置ルール
表示環境変更時、サイドバーは以下のルールで再配置される。

#### 14.3.1 配置基準
- 配置基準は **選択中モニタの画面全体領域（MonitorArea）** とする  
  （作業領域 WorkArea は使用しない）
- 右端ドックは以下の計算で決定する  
  - `left = MonitorArea.right - sidebar_width_px`
  - `top = MonitorArea.top`
  - `height = MonitorArea.height`

#### 14.3.2 幅の扱い
- 幅は `settings.json` の `window.sidebar_width_px` を使用する
- 解像度変更・DPI変更があっても、**論理的な幅値は維持**する
- 不正値の場合は 12.4 のフォールバック規則に従う

---

### 14.4 作業領域確保（被らない挙動）
- 再配置時は、必ず OS の作業領域確保機構（AppBar 相当）を再適用する
- これにより、他アプリを最大化した場合もサイドバー領域に重ならない状態を維持する
- 再適用順序は以下を原則とする  
  1. 希望位置を OS に提示  
  2. OS が調整した位置を確定  
  3. サイドバーウィンドウを確定位置に追従させる

---

### 14.5 モニタ指定との関係
- 表示先モニタは 7章・12章の仕様を優先する  
  - `display.target_monitor = main / sub`
- 解像度変更等により対象モニタが一時的に使用不可となった場合：  
  - 自動的に `main` にフォールバックする
- 表示環境が復旧した場合：  
  - 再度設定値に従って再配置される

---

### 14.6 再配置タイミング
- 表示環境変更は短時間に複数回発生する場合がある
- 再配置処理は、最終的な状態が確定した後に **一度だけ** 実行する
- 再配置の完了をもって UI は安定状態とみなす

---

### 14.7 ユーザーへの影響
- 表示環境変更中、一瞬の位置調整が発生する場合がある
- チェック状態・選択中リスト等の内部状態は影響を受けない
- ユーザー操作を必要とするダイアログ等は表示しない

## 15. セキュリティ要件（最小構成）

本章では、本アプリにおける最低限のセキュリティ要件および
安定稼働を阻害するリスクを低減するための制約を定義する。

---

### 15.1 基本方針
- 本アプリは業務支援用のローカルアプリケーションであり、
  高度な認証・暗号化等はスコープ外とする
- ただし、**異常データ・過剰データによるメモリ消費やアプリ停止を防ぐ**
  ことを目的として、入力ファイルに明確な制限を設ける
- 「安全側に倒す」設計とし、条件を満たさない場合は処理を継続しない

---

### 15.2 ファイルサイズ制限
以下のファイルについて、**1ファイルあたり最大 5MB** を上限とする。

| 対象ファイル | 説明 |
|-------------|------|
| checklist.json | チェックリスト定義ファイル |
| settings.json | 設定ファイル |
| yyyy-mm-dd.json | チェック状態保存ファイル |

- ファイルサイズは、読み込み前に必ず検証する
- サイズ判定は OS 上のファイルサイズ（バイト数）を基準とする
- 5MB を超過した場合は、該当ファイルを **不正データ** とみなす

---

### 15.3 サイズ超過時の挙動
#### 15.3.1 checklist.json
- 5MB を超過している場合：
  - 「JSONファイルエラー」として扱う
  - エラー表示を行い、起動は継続する（11.3 に準拠）

#### 15.3.2 settings.json
- 5MB を超過している場合：
  - 「JSONファイルエラー」として扱う
  - エラー表示後、アプリは終了してよい（12.3 に準拠）

#### 15.3.3 yyyy-mm-dd.json（保存ファイル）
- 5MB を超過している場合：
  - 保存処理を中断する
  - トーストで「サイズ超過のため保存できません」と通知する
  - アプリの継続動作には影響を与えない

---

### 15.4 メモリ使用抑制に関する要件
- JSON ファイルは **一括読み込み** を前提とするが、
  サイズ制限により過剰なメモリ消費を防止する
- ファイル読み込み前に以下を必ず実施する：
  1. ファイル存在確認  
  2. ファイルサイズ確認  
  3. サイズ条件を満たす場合のみ読み込み

---

### 15.5 外部取得（API／共有サーバ）時の扱い
- API／共有サーバから取得する JSON データについても、
  **取得後のサイズが 5MB を超える場合は不正データとして扱う**
- サイズ超過時の挙動は、ローカルの checklist.json と同等とする
- キャッシュファイル（checklist.cache.json）についても同様に 5MB 制限を適用する

---

### 15.6 想定外データへの耐性
- 以下のケースでは、アプリが異常終了しないことを必須とする
  - 巨大 JSON ファイル
  - 意図的に肥大化した保存ファイル
  - 不正な構造の JSON
- 例外発生時は、可能な限り既存仕様に基づいたエラー表示にフォールバックする


## 16. スコープ外（明確化）
- 自動起動（ログオン起動）
- トレイ常駐（非表示運用）
- version不一致チェック（checklist/settingsともに）
- チェック状態の永続化（将来検討）
- タスクバー位置が下以外の環境への最適化
- ゲーム等の排他フルスクリーン例外
- マルチモニタ2枚以上の対応
